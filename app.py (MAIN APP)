import streamlit as st
from modules.ar_scanner import scan_room, show_room_visualization
from modules.climate_advisor import show_recommendation
from modules.ai_designer import ai_refine_design
from modules.virtual_tryon import show_virtual_tryon
from modules.circular_service import show_circular_service

# Page configuration
st.set_page_config(
    page_title="IN SPACE FURNITURE",
    page_icon="ğŸª‘",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        color: #2A5C3D;
        text-align: center;
        margin-bottom: 1rem;
    }
    .sub-header {
        font-size: 1.2rem;
        color: #666;
        text-align: center;
        margin-bottom: 2rem;
    }
    .feature-card {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 10px 0;
        border-left: 4px solid #2A5C3D;
    }
    .stProgress > div > div > div > div {
        background-color: #2A5C3D;
    }
</style>
""", unsafe_allow_html=True)

# Initialize session state
if 'room_data' not in st.session_state:
    st.session_state.room_data = None
if 'design_data' not in st.session_state:
    st.session_state.design_data = None
if 'quote' not in st.session_state:
    st.session_state.quote = None

# Sidebar navigation
with st.sidebar:
    st.image("https://img.icons8.com/color/96/000000/armchair.png", width=80)
    st.title("IN SPACE")
    st.caption("Furniture That Fits â€¢ AI That Designs â€¢ Planet That Benefits")
    
    st.divider()
    
    page = st.radio(
        "Navigate Your Journey:",
        [
            "ğŸ  Home",
            "ğŸ“± 1. Scan Room",
            "ğŸŒ³ 2. Material Advisor", 
            "ğŸ¨ 3. AI Design Studio",
            "ğŸ‘— 4. Virtual Try-On",
            "ğŸ’° 5. Quote & Order",
            "â™»ï¸ 6. Circular Service",
            "ğŸ“Š Investor View"
        ],
        index=0
    )
    
    st.divider()
    
    if st.session_state.room_data:
        st.success("âœ… Room scanned")
    if st.session_state.design_data:
        st.success("âœ… Design created")
    
    st.caption("Demo Version 1.0")
    if st.button("ğŸ”„ Reset Demo"):
        for key in list(st.session_state.keys()):
            del st.session_state[key]
        st.rerun()

# Main page content
if page == "ğŸ  Home":
    st.markdown('<div class="main-header">IN SPACE FURNITURE</div>', unsafe_allow_html=True)
    st.markdown('<div class="sub-header">From Room Scan to Circular Design â€” Furniture That Fits Your Space, Style, and Planet</div>', unsafe_allow_html=True)
    
    # Hero image
    st.image("https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=1200", 
             use_column_width=True, 
             caption="Design. Preview. Live Sustainably.")
    
    # Value proposition
    col1, col2, col3 = st.columns(3)
    
    with col1:
        with st.container(border=True):
            st.markdown("### ğŸ“± Scan")
            st.write("AR room mapping + climate analysis")
            st.caption("Know what fits, what lasts")
    
    with col2:
        with st.container(border=True):
            st.markdown("### ğŸ¨ Design")
            st.write("AI-powered furniture designer")
            st.caption("From idea to professional design")
    
    with col3:
        with st.container(border=True):
            st.markdown("### â™»ï¸ Sustain")
            st.write("Circular repair & upcycling")
            st.caption("Lifetime value, zero waste")
    
    st.divider()
    
    # Quick start
    st.markdown("### ğŸš€ Quick Start")
    start_col1, start_col2, start_col3 = st.columns(3)
    
    with start_col1:
        if st.button("Start with Room Scan", type="primary", use_container_width=True):
            st.session_state.page = "ğŸ“± 1. Scan Room"
            st.rerun()
    
    with start_col2:
        if st.button("Try AI Designer", use_container_width=True):
            st.session_state.page = "ğŸ¨ 3. AI Design Studio"
            st.rerun()
    
    with start_col3:
        if st.button("See Circular Service", use_container_width=True):
            st.session_state.page = "â™»ï¸ 6. Circular Service"
            st.rerun()
    
    # Stats
    st.divider()
    st.markdown("### ğŸ“Š By The Numbers")
    
    stat_col1, stat_col2, stat_col3, stat_col4 = st.columns(4)
    
    with stat_col1:
        st.metric("Returns Reduced", "47%", "via virtual try-on")
    with stat_col2:
        st.metric("Lifespan Increased", "3.2x", "with climate-matched materials")
    with stat_col3:
        st.metric("Waste Diverted", "85%", "through circular service")
    with stat_col4:
        st.metric("Design Time", "-70%", "with AI refinement")

elif page == "ğŸ“± 1. Scan Room":
    st.title("Step 1: Room Scanning")
    st.write("Scan your space with AR to get precise measurements and climate analysis.")
    
    room_data = scan_room()
    
    if room_data:
        st.session_state.room_data = room_data
        show_room_visualization(room_data)
        
        # Next step button
        st.divider()
        if st.button("Next: Material Recommendation â†’", type="primary", use_container_width=True):
            st.session_state.page = "ğŸŒ³ 2. Material Advisor"
            st.rerun()

elif page == "ğŸŒ³ 2. Material Advisor":
    st.title("Step 2: Smart Material Selection")
    st.write("Based on your room's climate, we recommend the perfect wood for durability.")
    
    if st.session_state.room_data:
        recommendation = show_recommendation(st.session_state.room_data['climate'])
        
        if recommendation:
            st.divider()
            col1, col2 = st.columns([3, 1])
            with col1:
                if st.button("Next: Design Your Furniture â†’", type="primary", use_container_width=True):
                    st.session_state.page = "ğŸ¨ 3. AI Design Studio"
                    st.rerun()
            with col2:
                if st.button("â† Back to Scan", use_container_width=True):
                    st.session_state.page = "ğŸ“± 1. Scan Room"
                    st.rerun()
    else:
        st.warning("Please scan your room first!")
        if st.button("Go to Room Scanner", type="primary"):
            st.session_state.page = "ğŸ“± 1. Scan Room"
            st.rerun()

elif page == "ğŸ¨ 3. AI Design Studio":
    st.title("Step 3: AI Design Studio")
    st.write("Design your furniture and let AI refine it into a cohesive, professional piece.")
    
    design_data = ai_refine_design()
    
    if design_data:
        st.session_state.design_data = design_data
        
        st.divider()
        col1, col2 = st.columns([3, 1])
        with col1:
            if st.button("Next: See It In Your Room â†’", type="primary", use_container_width=True):
                st.session_state.page = "ğŸ‘— 4. Virtual Try-On"
                st.rerun()
        with col2:
            if st.button("â† Back", use_container_width=True):
                st.session_state.page = "ğŸŒ³ 2. Material Advisor"
                st.rerun()

elif page == "ğŸ‘— 4. Virtual Try-On":
    st.title("Step 4: Virtual Try-On")
    st.write("See your designed furniture in your room before you buy.")
    
    if st.session_state.room_data:
        fit_score = show_virtual_tryon(st.session_state.room_data, st.session_state.design_data)
        
        st.divider()
        if fit_score and fit_score > 80:
            st.success(f"âœ… Excellent fit! Ready to order.")
            
            col1, col2 = st.columns([3, 1])
            with col1:
                if st.button("Get Quote & Order â†’", type="primary", use_container_width=True):
                    st.session_state.page = "ğŸ’° 5. Quote & Order"
                    st.rerun()
            with col2:
                if st.button("â† Redesign", use_container_width=True):
                    st.session_state.page = "ğŸ¨ 3. AI Design Studio"
                    st.rerun()
        else:
            st.warning("Consider adjusting your design for better fit.")
            if st.button("Redesign with AI", type="primary"):
                st.session_state.page = "ğŸ¨ 3. AI Design Studio"
                st.rerun()
    else:
        st.warning("Please complete previous steps first!")
        if st.button("Start with Room Scan", type="primary"):
            st.session_state.page = "ğŸ“± 1. Scan Room"
            st.rerun()

elif page == "ğŸ’° 5. Quote & Order":
    st.title("Step 5: Quote & Order")
    st.write("Transparent pricing and seamless ordering.")
    
    # Calculate quote
    base_price = 1200
    
    if st.session_state.get('recommendation'):
        if st.session_state.recommendation.get('wood') == 'Teak':
            base_price = 1400
        elif st.session_state.recommendation.get('wood') == 'Walnut/Oak Blend':
            base_price = 1800
    
    # Display quote
    col1, col2 = st.columns([2, 1])
    
    with col1:
        st.subheader("Order Summary")
        
        st.write("**Items:**")
        if st.session_state.design_data:
            furniture_type = st.session_state.design_data['original']['furniture_type']
            st.write(f"- {furniture_type} (Custom Design)")
        else:
            st.write("- Custom Sofa")
        
        if st.session_state.get('recommendation'):
            st.write(f"- Material: {st.session_state.recommendation['wood']}")
            st.write(f"- Sustainability: {st.session_state.recommendation['sustainability']}")
        
        st.divider()
        
        st.write("**Cost Breakdown:**")
        st.write(f"- Materials: ${int(base_price * 0.5)}")
        st.write(f"- Craftsmanship: ${int(base_price * 0.35)}")
        st.write(f"- Sustainable Finish: ${int(base_price * 0.1)}")
        st.write(f"- Circular Service Fee: ${int(base_price * 0.05)}")
        
        st.divider()
        st.metric("Total", f"${base_price}", "All-inclusive")
        
        # Order button
        if st.button("ğŸ›’ Place Order", type="primary", use_container_width=True):
            st.session_state.quote = base_price
            st.success("Order placed successfully!")
            st.balloons()
            st.info("Expected delivery: 3-4 weeks. You'll receive tracking updates.")
    
    with col2:
        st.subheader("Order Timeline")
        
        timeline = [
            {"Step": "Design Finalization", "Time": "1-2 days", "Status": "âœ…"},
            {"Step": "Material Sourcing", "Time": "3-5 days", "Status": "â³"},
            {"Step": "Craftsmanship", "Time": "10-14 days", "Status": "ğŸ“…"},
            {"Step": "Quality Check", "Time": "2-3 days", "Status": "ğŸ“…"},
            {"Step": "Delivery", "Time": "3-5 days", "Status": "ğŸ“…"}
        ]
        
        for item in timeline:
            st.write(f"{item['Status']} **{item['Step']}**")
            st.caption(f"{item['Time']}")
            st.progress(0.2 if item['Status'] == "â³" else 1.0 if item['Status'] == "âœ…" else 0.0)
        
        st.divider()
        st.write("**Warranty:** 5 years")
        st.write("**Circular Service:** Included")
    
    st.divider()
    
    if st.button("Next: Learn About Circular Service â†’", use_container_width=True):
        st.session_state.page = "â™»ï¸ 6. Circular Service"
        st.rerun()

elif page == "â™»ï¸ 6. Circular Service":
    st.title("Step 6: Circular Service")
    st.write("Extend your furniture's life. Repair, upcycle, or recycle responsibly.")
    
    show_circular_service()
    
    st.divider()
    st.success("""
    **Complete the Cycle:** 
    Every IN SPACE purchase includes our circular service guarantee.
    Your furniture will never end up in a landfill.
    """)

elif page == "ğŸ“Š Investor View":
    st.title("IN SPACE FURNITURE - Investor Overview")
    
    # Executive Summary
    st.header("ğŸ¯ Executive Summary")
    st.write("""
    IN SPACE is an AI-powered furniture ecosystem that combines AR room scanning, 
    climate-aware material recommendations, AI design refinement, and circular economy services.
    We're addressing the $800B furniture industry's core problems: poor fit, material failure, 
    design frustration, and environmental waste.
    """)
    
    # Market Opportunity
    st.header("ğŸ“ˆ Market Opportunity")
    
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("Global Furniture Market", "$800B")
    with col2:
        st.metric("Online Furniture Growth", "18% CAGR")
    with col3:
        st.metric("Sustainable Furniture Demand", "$90B")
    
    # Technology Stack
    st.header("ğŸ› ï¸ Technology Stack")
    
    tech_col1, tech_col2 = st.columns(2)
    
    with tech_col1:
        st.write("**Core IP:**")
        st.write("- Proprietary AR scanning algorithm")
        st.write("- Climate-material recommendation engine")
        st.write("- AI design refinement model (GAN-based)")
        st.write("- Circular logistics platform")
    
    with tech_col2:
        st.write("**Development:**")
        st.write("- **MVP:** Streamlit (this demo)")
        st.write("- **Phase 2:** React Native + ARKit/ARCore")
        st.write("- **Phase 3:** Custom AI/ML deployment")
    
    # Business Model
    st.header("ğŸ’° Business Model")
    
    revenue_streams = {
        "Stream": ["Furniture Sales", "AI Design License", "Circular Subscriptions", "Data Insights"],
        "Margin": ["40%", "85%", "70%", "90%"],
        "Year 1": ["$500K", "$50K", "$30K", "$20K"],
        "Year 3": ["$8M", "$1.2M", "$800K", "$500K"]
    }
    
    import pandas as pd
    st.dataframe(pd.DataFrame(revenue_streams), use_container_width=True, hide_index=True)
    
    # Funding Ask
    st.header("ğŸ’µ Funding Request")
    
    funding_col1, funding_col2, funding_col3 = st.columns(3)
    
    with funding_col1:
        st.metric("Seed Round", "$1.5M")
    with funding_col2:
        st.metric("Runway", "18 months")
    with funding_col3:
        st.metric("Valuation (post)", "$8M")
    
    st.write("**Use of Funds:**")
    st.write("- 50%: Tech development (AR/AI team)")
    st.write("- 30%: Pilot program & partnerships")
    st.write("- 15%: Operations & marketing")
    st.write("- 5%: Legal & IP protection")
    
    # Team
    st.header("ğŸ‘¥ Team")
    st.write("- **Founder:** [Your Name] - Furniture design + tech vision")
    st.write("- **Seeking:** CTO with AR/AI experience")
    st.write("- **Advisors:** Furniture industry veterans, sustainability experts")
    
    # Next Steps
    st.header("ğŸš€ Next Steps")
    st.write("1. Build native AR app (React Native)")
    st.write("2. Partner with 3 artisan workshops")
    st.write("3. Launch pilot program (100 customers)")
    st.write("4. Raise Series A ($5M) in 18 months")

# Footer
st.divider()
footer_col1, footer_col2, footer_col3 = st.columns([2, 1, 1])

with footer_col1:
    st.caption("IN SPACE FURNITURE Â© 2024 | Demo Version 1.0")

with footer_col2:
    st.caption("[GitHub Repo](https://github.com)")

with footer_col3:
    st.caption("[Contact: hello@inspace.furniture](mailto:hello@inspace.furniture)")
